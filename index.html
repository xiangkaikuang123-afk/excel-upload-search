<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BOA - PDF Tools</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family:'Segoe UI',sans-serif; background:#f1f1f1; margin:0; padding:0; }
    header { background:#e91e63; color:white; text-align:center; padding:30px 0; font-size:28px; font-weight:bold; }
    nav { display:flex; justify-content:center; gap:20px; margin-top:20px; flex-wrap:wrap; }
    nav button { padding:12px 25px; border:none; background:#e91e63; color:white; border-radius:25px;
                 font-size:16px; cursor:pointer; }
    nav button.active { background:#ad1457; }
    main { max-width:800px; margin:40px auto; background:white; border-radius:8px;
           box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:30px; }
    section { display:none; }
    section.active { display:block; }
    h2 { color:#e91e63; }
    .dropzone { border:2px dashed #e91e63; border-radius:10px; padding:30px; text-align:center;
                color:#888; margin:20px 0; cursor:pointer; }
    .file-preview { margin-top:10px; padding:10px; border:1px solid #ccc; border-radius:5px;
                    background:#f9f9f9; }
    .file-preview button { background:#e53935; color:white; border:none; border-radius:3px;
                           padding:3px 6px; cursor:pointer; }
    .status { margin-top:10px; font-weight:bold; color:green; }
    .link-container { margin:20px 0; }
    .link-container a { padding:10px 15px; background:#e91e63; color:white; border-radius:5px;
                        display:inline-block; text-decoration:none; }
  </style>
</head>

<body>
<header>BOA - PDF Tools</header>

<nav>
  <button onclick="showSection('merge')" class="active">Merge</button>
  <button onclick="showSection('split')">Split</button>
  <button onclick="showSection('rename')">Rename</button>
  <button onclick="showSection('summary')">Summary</button>
</nav>

<main>

<!-- MERGE -->
<section id="merge" class="active">
  <h2>Merge PDF</h2>
  <div class="dropzone" id="mergeDropzone" onclick="triggerMergeInput()">Click or Drop PDFs to Merge</div>
  <input type="file" id="mergeFileInput" style="display:none" accept="application/pdf" multiple>
  <div id="mergePreview"></div>
  <button onclick="mergePDFs()">Merge Now</button>
  <p class="status" id="mergeStatus"></p>
</section>

<!-- SPLIT -->
<section id="split">
  <h2>Split PDF</h2>
  <div class="dropzone" id="splitDropzone" onclick="document.getElementById('splitInput').click()">Click or Drop PDF</div>
  <input type="file" id="splitInput" style="display:none" accept="application/pdf">
  <div id="splitPreview"></div>
  <button onclick="splitPDF()">Split Now</button>
  <p class="status" id="splitStatus"></p>
</section>

<!-- RENAME -->
<section id="rename">
  <h2>Rename PDFs</h2>

  <p>Upload Excel (1st column = File No, 2nd = Name)</p>
  <input type="file" id="excelInput" accept=".xlsx,.xls"><br><br>

  <p>Upload ZIP containing PDFs</p>
  <input type="file" id="pdfFolderZip" accept="application/zip"><br><br>

  <button onclick="renameFromExcel()">Rename PDFs</button>

  <p class="status" id="renameStatus"></p>
</section>

<!-- Summary -->
<section id="summary">
  <h2>SUMMARY LISTING</h2>
  <div class="link-container">
    <a href="https://docs.google.com/spreadsheets/d/1aw9ZMyCajGGf1-Iq1dnf2J8t9SMJoA6f" target="_blank">
      SEMENYIH Google Sheet
    </a>
    <a href="https://docs.google.com/spreadsheets/d/198ZZZoJsOH8DrI7b5F-5hqvIIjP1jpModcEh-deo44o" target="_blank">
      N2 Google Sheet
    </a>
  </div>
</section>

</main>

<script>
/* ---------------- NAVIGATION ---------------- */
function showSection(id) {
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.querySelector(`nav button[onclick="showSection('${id}')"]`).classList.add("active");
}

/* ---------------- MERGE ---------------- */
let mergeFiles = [];

function triggerMergeInput() {
  document.getElementById('mergeFileInput').click();
}

document.getElementById('mergeFileInput').addEventListener('change', e => {
  mergeFiles = [...mergeFiles, ...Array.from(e.target.files)];
  renderMergePreview();
});

function renderMergePreview() {
  const container = document.getElementById('mergePreview');
  container.innerHTML = '';

  mergeFiles.forEach((file, i) => {
    const div = document.createElement('div');
    div.className = 'file-preview';
    div.innerHTML = `<span>${file.name}</span>
                     <button onclick="removeMergeFile(${i})">X</button>`;
    container.appendChild(div);
  });
}

function removeMergeFile(index) {
  mergeFiles.splice(index, 1);
  renderMergePreview();
}

async function mergePDFs() {
  const status = document.getElementById('mergeStatus');
  status.textContent = "";

  if (mergeFiles.length < 2) return alert("Add at least 2 PDFs");

  const merged = await PDFLib.PDFDocument.create();

  for (let file of mergeFiles) {
    const bytes = await file.arrayBuffer();
    const pdf = await PDFLib.PDFDocument.load(bytes);
    const pages = await merged.copyPages(pdf, pdf.getPageIndices());
    pages.forEach(p => merged.addPage(p));
  }

  const mergedBytes = await merged.save();
  const blob = new Blob([mergedBytes], { type: "application/pdf" });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "Merged.pdf";
  link.click();

  status.textContent = "✔ Merged Successfully.";
  mergeFiles = [];
  renderMergePreview();
}

document.getElementById('mergeDropzone').addEventListener('dragover', e => {
  e.preventDefault();
  e.target.style.background = "#ffe6f0";
});
document.getElementById('mergeDropzone').addEventListener('dragleave', e => {
  e.target.style.background = "";
});
document.getElementById('mergeDropzone').addEventListener('drop', e => {
  e.preventDefault();
  e.target.style.background = "";
  mergeFiles = [...mergeFiles, ...Array.from(e.dataTransfer.files)];
  renderMergePreview();
});

/* ---------------- SPLIT ---------------- */
let splitFile = null;

document.getElementById('splitInput').addEventListener('change', e => {
  splitFile = e.target.files[0];
  renderSplitPreview();
});

function renderSplitPreview() {
  const container = document.getElementById('splitPreview');
  container.innerHTML = '';

  if (splitFile) {
    container.innerHTML = `<div class="file-preview">
                             <span>${splitFile.name}</span>
                             <button onclick="removeSplitFile()">X</button>
                           </div>`;
  }
}

function removeSplitFile() {
  splitFile = null;
  document.getElementById('splitInput').value = "";
  renderSplitPreview();
}

document.getElementById('splitDropzone').addEventListener('dragover', e => {
  e.preventDefault();
  e.target.style.background = "#ffe6f0";
});
document.getElementById('splitDropzone').addEventListener('dragleave', e => {
  e.target.style.background = "";
});
document.getElementById('splitDropzone').addEventListener('drop', e => {
  e.preventDefault();
  e.target.style.background = "";
  const files = Array.from(e.dataTransfer.files).filter(f => f.type === "application/pdf");
  if (files.length > 0) {
    splitFile = files[0];
    renderSplitPreview();
  }
});

async function splitPDF() {
  const status = document.getElementById('splitStatus');
  status.textContent = "";

  if (!splitFile) return alert("Select a PDF first");

  const zip = new JSZip();
  const bytes = await splitFile.arrayBuffer();
  const pdf = await PDFLib.PDFDocument.load(bytes);

  for (let i = 0; i < pdf.getPageCount(); i++) {
    const newPdf = await PDFLib.PDFDocument.create();
    const [page] = await newPdf.copyPages(pdf, [i]);
    newPdf.addPage(page);
    const pageBytes = await newPdf.save();
    zip.file(`Page-${i + 1}.pdf`, pageBytes);
  }

  const zipBlob = await zip.generateAsync({ type: "blob" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(zipBlob);
  link.download = "SplitPages.zip";
  link.click();

  status.textContent = "✔ PDF split completed.";
  removeSplitFile();
}

/* ---------------- RENAME (FIXED) ---------------- */
async function renameFromExcel() {
  const excelFile = document.getElementById('excelInput').files[0];
  const zipFile = document.getElementById('pdfFolderZip').files[0];
  const status = document.getElementById('renameStatus');

  status.textContent = "";

  if (!excelFile || !zipFile) {
    alert("Upload Excel and ZIP");
    return;
  }

  const excelMap = await readExcelToMap(excelFile);
  const zipData = await JSZip.loadAsync(zipFile);

  const pdfFiles = Object.keys(zipData.files).filter(n => n.endsWith(".pdf"));

  const outZip = new JSZip();
  let renamedCount = 0;
  let missingList = [];

  for (const pdfName of pdfFiles) {
    const fileNumber = pdfName.replace(/\D/g, ""); // extract digits only

    if (excelMap[fileNumber]) {
      const newName = `${fileNumber}-${excelMap[fileNumber]}.pdf`;
      const content = await zipData.files[pdfName].async("uint8array");
      outZip.file(newName, content);
      renamedCount++;
    } else {
      missingList.push(pdfName);
    }
  }

  const finalZip = await outZip.generateAsync({ type: "blob" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(finalZip);
  link.download = "RenamedPDFs.zip";
  link.click();

  status.textContent =
    `✔ Renamed ${renamedCount} PDFs. Missing: ${missingList.length}`;
}

async function readExcelToMap(file) {
  return new Promise(resolve => {
    const reader = new FileReader();

    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      let map = {};

      for (let i = 1; i < rows.length; i++) {
        let number = rows[i][0];
        let name = rows[i][1];

        if (!number || !name) continue;

        number = number.toString().trim();
        name = name.toString().replace(/^-+/, "").trim();

        map[number] = name;
      }

      resolve(map);
    };

    reader.readAsArrayBuffer(file);
  });
}
</script>

</body>
</html>
