<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BOA - PDF Tools</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f1f1f1; margin:0; padding:0; }
    header { background:#e91e63; color:#fff; text-align:center; padding:25px 0; font-size:28px; }
    main { max-width:800px; margin:40px auto; background:#fff; padding:25px; border-radius:10px; }
    h2 { color:#e91e63; }
    .status { margin-top:10px; font-weight:bold; color:green; }
  </style>
</head>

<body>

<header>BOA - PDF Tools</header>

<main>
  <h2>Rename PDFs</h2>

  <p>Upload Excel (File No in Col A, Name in Col B)</p>
  <input type="file" id="excelInput" accept=".xlsx,.xls"><br><br>

  <p>Upload ZIP containing PDFs</p>
  <input type="file" id="pdfZip" accept="application/zip"><br><br>

  <button onclick="renameFromExcel()">Rename PDFs</button>
  <p id="renameStatus" class="status"></p>
</main>

<script>
async function renameFromExcel() {
  const status = document.getElementById("renameStatus");
  status.textContent = "";

  const excelFile = document.getElementById("excelInput").files[0];
  const zipFile = document.getElementById("pdfZip").files[0];

  if (!excelFile || !zipFile) {
    status.textContent = "Please upload both Excel and ZIP.";
    return;
  }

  try {
    // Read Excel
    const excelData = await excelFile.arrayBuffer();
    const wb = XLSX.read(excelData, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // Build mapping
    const mapping = {};

    rows.forEach(row => {
      const num = row[0];
      const name = row[1];

      if (!num || !name) return;

      const key = num.toString().trim();
      const cleanLabel = name.toString().trim();

      mapping[key] = cleanLabel;
    });

    // Load ZIP
    const jszip = new JSZip();
    const inputZip = await jszip.loadAsync(zipFile);
    const outputZip = new JSZip();

    // Process each PDF
    for (const filename of Object.keys(inputZip.files)) {
      const file = inputZip.files[filename];

      if (!filename.toLowerCase().endsWith(".pdf")) continue;

      const base = filename.replace(".pdf", "").trim();

      // Match by exact number
      const matchLabel = mapping[base];

      const pdfData = await file.async("arraybuffer");

      if (matchLabel) {
        // Ensure no illegal characters
        const safeLabel = matchLabel.replace(/[<>:"/\\|?*]/g, "");

        const newName = `${base}${safeLabel}.pdf`;
        outputZip.file(newName, pdfData);
      } else {
        // Keep original if no match
        outputZip.file(filename, pdfData);
      }
    }

    // Download ZIP
    const blob = await outputZip.generateAsync({ type: "blob" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Renamed_PDFs.zip";
    link.click();

    status.textContent = "Renaming completed successfully.";
  } catch (err) {
    console.error(err);
    status.textContent = "Error occurred during renaming.";
  }
}
</script>

</body>
</html>
